MÔ HÌNH 4: KIẾN TRÚC SDN AUTOMATION & DYNAMIC QoS
Khái quát: Kiến trúc SDN (Software-Defined Networking) tạo ra một cuộc cách mạng bằng cách tách rời Control Plane (Bộ não quyết định đường đi) ra khỏi Data Plane (Phần cứng chuyển tiếp gói tin). Toàn bộ các Switch trong Campus giờ đây trở thành những thiết bị "ngu" (White-box Switch), chỉ biết ngoan ngoãn thực thi các luật (Flow Table) được đẩy xuống từ một trung tâm điều khiển duy nhất (SDN Controller như Ryu hoặc ONOS).
1. Quy hoạch Logic & Giao thức Mạng (SDN Logic & OpenFlow)
Trong SDN, chúng ta không còn phụ thuộc vào các giao thức tự động chậm chạp như STP hay cấu hình QoS tĩnh cứng nhắc trên từng Switch nữa.
•	Giao tiếp Nam-Bắc (Southbound API): Bộ điều khiển trung tâm sử dụng giao thức OpenFlow để liên lạc với tất cả các Switch. Controller sẽ có được một cái nhìn toàn cảnh (God-eye view) về toàn bộ sơ đồ mạng (Topology) và trạng thái lưu lượng của từng cổng tính bằng mili-giây.
•	Giao tiếp Bắc-Nam (Northbound API): Cho phép Quản trị viên viết các ứng dụng Python (Network Apps) để thao tác với mạng.
•	Dynamic QoS Logic (Kịch bản Giải cứu WAN): Chúng ta sẽ viết một script trên Controller có logic như sau:
1.	Liên tục thu thập thống kê port (Port Stats) của cổng WAN trên Edge Router (giới hạn 200Mbps).
2.	Nếu WAN_Bandwidth > 180Mbps (Chạm ngưỡng 90% tải trọng).
3.	Controller ngay lập tức đẩy một lệnh OpenFlow xuống Switch của Ký túc xá (VLAN 30): "Rate-limit toàn bộ IP dải 10.0.30.x xuống mức 1Mbps".
4.	Cổng WAN được giải phóng, dành đường ưu tiên tuyệt đối cho Ban Giám Hiệu (VLAN 10).
5.	Khi KTX ngưng tải nặng, Controller tự động gỡ luật Rate-limit, trả lại băng thông bình thường.
2. Thiết kế Cấu trúc Liên kết (Topology Design)
Về mặt vật lý, sơ đồ nối cáp có thể giữ nguyên như Mô hình 3 (Spine-Leaf) để đảm bảo hiệu năng tối đa cho kết nối nội bộ. Điểm khác biệt duy nhất nằm ở mạng Quản trị (Management Network).
•	Mạng Out-of-Band (OOB): Mỗi Switch L2, Switch L3 hay Router biên đều phải có một đường cáp kết nối vật lý (hoặc ảo hóa trong Mininet) trỏ thẳng về IP của SDN Controller (ví dụ 127.0.0.1 port 6633 hoặc 6653).
•	Không có "Trí tuệ cục bộ": Các Switch không tự xây dựng bảng MAC (MAC learning) hay bảng định tuyến. Mọi gói tin lạ đầu tiên đi vào mạng đều được Switch đóng gói gửi lên Controller để hỏi đường (Packet-In). Controller tính toán xong sẽ gửi chỉ thị xuống (Packet-Out và Flow-Mod).

1. Bảng Kê Thiết Bị (Bill of Materials)
Về mặt phần cứng chuyển tiếp dữ liệu (Data Plane), chúng ta có thể tận dụng lại nguyên xi sơ đồ vật lý của Mô hình 2 (Kiến trúc 3 Lớp) hoặc Mô hình 3 (Spine-Leaf) đều được. Điểm khác biệt lớn nhất là sự xuất hiện của một thực thể hoàn toàn mới:
•	1 x SDN Controller (Bộ Điều Khiển Trung Tâm): Đây là một phần mềm (như Ryu, ONOS, hoặc POX) chạy trên một Server độc lập hoặc trực tiếp trên máy Host giả lập của bạn. Nó là "bộ não" duy nhất của toàn mạng.
•	19 x White-box Switches (Core/Dist/Access): Không cần mua thiết bị Cisco/Juniper đắt tiền. Tất cả Switch giờ đây trở thành các thiết bị "ngu" (dumb switch) chỉ hỗ trợ giao thức OpenFlow.
•	1 x Edge Router: Nút thắt cổ chai ra WAN. (Trong môi trường Open vSwitch của Mininet, Switch L3 này cũng được điều khiển bằng SDN).
•	70 x Hosts: Vẫn giữ nguyên 69 máy nội bộ và 1 Server HCM đầu xa.
________________________________________
2. Chi tiết Kết nối và Băng thông (Links & Bandwidth)
Về liên kết vật lý (Data Link), băng thông giữa các thiết bị nội bộ (1Gbps) và đường WAN (200Mbps) vẫn giữ nguyên. Tuy nhiên, kiến trúc SDN sinh ra một loại kết nối hoàn toàn mới:
•	Mạng Quản trị Ảo (Out-of-Band Management): Trong Mininet, ngay khi bạn khai báo controller=RemoteController, môi trường sẽ tự động tạo ra một mạng ẩn độc lập. TẤT CẢ 19 Switch và Router biên đều có một đường kết nối (TCP port 6633 hoặc 6653) trỏ thẳng về IP của Controller.
•	Luồng Giao tiếp OpenFlow: Switch không tự nói chuyện với nhau. Khi một gói tin lạ xuất hiện ở cổng của Switch, nó sẽ được bọc lại và bắn thẳng lên Controller qua đường kết nối này (bản tin Packet-In) để xin chỉ thị.
________________________________________
3. Cấu hình Chi tiết (Configuration Checklist)
Đây là nơi sự kỳ diệu của việc "Lập trình mạng" (Network as Code) tỏa sáng. Cấu hình lúc này không nằm trên thiết bị, mà nằm trong File Python của Controller.
A. Trạng thái "Trắng" trên 19 Switch & Router (Zero-Touch Provisioning)
•	Xóa bỏ mọi giao thức: Tuyệt đối KHÔNG cấu hình IP, KHÔNG chia VLAN tĩnh, KHÔNG bật STP, KHÔNG định tuyến OSPF/BGP trên bất kỳ Switch nào.
•	Chỉ thị duy nhất: Thiết lập các Switch này trỏ về bộ điều khiển (Ví dụ lệnh trên Open vSwitch: ovs-vsctl set-controller s1 tcp:127.0.0.1:6653).
•	Bản chất: Bảng MAC Table và Routing Table của Switch ban đầu trống rỗng. Nếu không có Controller, mạng sẽ hoàn toàn tê liệt.
B. Cấu hình trên 69 Hosts Nội bộ
•	Các máy PC và Server vẫn giữ nguyên IP, Subnet Mask và trỏ Default Gateway về IP của Router Biên như bình thường (Các PC không hề biết mạng đã chuyển sang dùng SDN).
C. Lập trình Bộ não: App Định Tuyến (Routing Script trên Controller)
Bạn phải khởi chạy một script Python (ví dụ dùng Ryu Controller) thực hiện nhiệm vụ:
•	Học MAC tự động (MAC Learning): Lắng nghe các bản tin ARP, tự động vẽ ra bản đồ toàn bộ mạng (Topology Discovery).
•	Tính toán đường đi ngắn nhất (Dijkstra): Khi có luồng dữ liệu mới từ máy Lab tới Server, Controller dùng thuật toán tính toán đường đi tối ưu nhất, sau đó đẩy các luật (Flow Rules) xuống các Switch liên quan (Flow-Mod). Switch sẽ lưu luật này vào phần cứng và từ đó chuyển tiếp luồng dữ liệu nội bộ với tốc độ tối đa (Giải quyết "Elephant Flow").
D. Lập trình Bộ não: App Dynamic QoS (Giải cứu nút thắt WAN)
Đây là cốt lõi của yêu cầu đề bài. Trên Controller, bạn viết thêm một module giám sát kịch bản WAN:
•	Bước 1: Giám sát (Polling): Cứ mỗi 1 giây, Controller gửi bản tin Port Stats Request xuống Switch đóng vai trò Edge Router để hỏi: "Cổng ra Server HCM đang chạy bao nhiêu Mbps?".
•	Bước 2: Phát hiện nghẽn (Trigger Threshold): Nếu phép tính trả về Băng thông WAN > 180 Mbps (90% tải trọng).
•	Bước 3: Thực thi Trừng phạt (Rate Limiting): Controller lập tức đẩy một lệnh Flow-Mod gắn kèm tính năng Meter Table (hoặc chuyển luồng vào Queue đã cấu hình sẵn) xuống Switch Ký túc xá:
o	Luật: Bất kỳ IP nguồn nào thuộc dải 10.0.3.x (Dorm) đi ra WAN đều bị ép xuống tốc độ 1 Mbps.
•	Bước 4: Giải cứu thành công: Băng thông cổng WAN lập tức giảm xuống, dư ra hàng trăm Mbps để luồng dữ liệu ERP của Ban Giám Hiệu (10.0.1.x) đi qua mượt mà, độ trễ Ping giảm về mức hoàn hảo.

